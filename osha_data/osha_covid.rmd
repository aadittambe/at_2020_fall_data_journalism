---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}

```

## About this notebook

This is our final project notebook by Aadit and Kara. We will write a proper intro later.


## Load packages

```{r}
# Load the tidyverse
#blscrapeR will allow us to get NAICS codes, which we will join with the complaint data to see to which industry most complaints related.


#install.packages("blscrapeR")
#install.packages("tidytext")
#install.packages("textstem")

library(tidyverse)
library(lubridate)
library(readxl)
library(janitor)
library(blscrapeR)
library(tidytext)
library(textstem)


```

## Load Data

```{r}

# PART 1: Open complaints
# create an object open_complaints
open_complaints <- read_excel("data/open_complaints.xlsx") %>%
  # format the dataset -- take out the first two rows because they weren't row headings
  remove_empty() %>%
  slice(-1) %>%
  # bring row headings to the first line of the dataset
  row_to_names(1) %>%
  clean_names() %>%
  # create a new column to check the status of the complaint -- open or closed.
  mutate(complaint_status = "open_complaint")

# PART 2: Closed complaints
# create an object closed_complaints
closed_complaints <- read_excel("data/closed_complaints.xlsx") %>%
  # same as part 1 -- take out the frist two rows because they weren't row headings
  remove_empty() %>%
  slice(-1) %>%
  # bring row headings to the first line of the dataset
  row_to_names(1) %>%
  clean_names() %>%
  # create a new column to check the status of the complaint -- open or closed.
  mutate(complaint_status = "closed_complaint")

# PART 3: Join part 1 with part 2
# create a new object "complaints." this will be our main dataset.
complaints <- closed_complaints %>%
  # use bind_rows to join the two datasets
  bind_rows(open_complaints) %>%
  # because Excel stores dates in a different format, we convert it to a number
  mutate(upa_receipt_date = as.numeric(upa_receipt_date)) %>%
  # then, we use the "excel_numeric_to_date" function to return an actual data
  mutate(upa_receipt_date = excel_numeric_to_date(upa_receipt_date))

# view complaints
complaints

  
``` 

## Examine data

```{r}
# view the data
closed_complaints
open_complaints
complaints

```


## Motivating questions

### Question 1: How many COVID-19-related complaints have been filed to OSHA?
## Answer: There were 31,278 closed complaints and 11,140 open complaints as of Nov. 6, 2020, for a total of 42,418 complaints.

```{r}
# Create a new object called "totals." Group by complaint status and count for each category.
totals <- complaints %>%
  group_by(complaint_status) %>%
  count() %>%
# Reshape the dataframe so that complaint statuses are in columns.
  pivot_wider(names_from = complaint_status, values_from = n) %>%
# Create a new column by adding the values from the "closed_complaint" and "open_complaint" columns.  
  mutate(total=closed_complaint+open_complaint)
  
totals
```


### Question 2. What types of industries are complaints coming from?
### Answer:

```{r}

#Pull in industry codes dataframe using blscrapeR package.
industry_codes <- naics

# create an object complaints_industry_codes
complaints_industry_codes <- complaints %>%
  # in this step, we separate the two NAICS codes into two columns: primary_site_naics_1 and primary_site_naics_2
  separate(primary_site_naics, sep = "/", into = c("primary_site_naics_1","primary_site_naics_2"))%>%
  # next, we take out the spaces before and after the codes using str_trim
  mutate(primary_site_naics_1 = str_trim(primary_site_naics_1, side = "both"))%>%
  mutate(primary_site_naics_2 = str_trim(primary_site_naics_2, side = "both"))%>%
  # if/else statement: if primary_site_naics_1 equals primary_site_naics_2, return true in another column, else, reuturn false
  mutate(naics_check = case_when(
    primary_site_naics_1 == primary_site_naics_2 ~ "true", 
    TRUE ~ "false"
    # primary_site_naics_1 != primary_site_naics_2 ~ "false"
  )) %>%
  # look at the first five digits of the codes
  mutate(primary_site_naics_1_5digit = str_sub(primary_site_naics_1, start = 1L, end = 5L)) %>%
  left_join(industry_codes, by = c("primary_site_naics_1_5digit" = "industry_code")) %>%
  rename(industry_title_5digit = industry_title) %>%
  # look at the first two digits of the code
  mutate(primary_site_naics_1_2digit = str_sub(primary_site_naics_1, start = 1L, end = 2L)) %>%
  left_join(industry_codes, by = c("primary_site_naics_1_2digit" = "industry_code")) %>%
  rename(industry_title_2digit = industry_title) %>%
  # look at the first three digits of the codes
  mutate(primary_site_naics_1_3digit = str_sub(primary_site_naics_1, start = 1L, end = 3L)) %>%
  left_join(industry_codes, by = c("primary_site_naics_1_3digit" = "industry_code")) %>%
  rename(industry_title_3digit = industry_title) 
  #group_by(industry_title_3digit) %>%
  #count()
  #filter(is.na(industry_title)) %>%
  #group_by(industry_title) %>%
  #count()
  #group_by(naics_check) %>%
  #count()

```


### Question 3. Which states have the most complaints?
### Answer: Oregon and California had the most complaints with 5,772 and 4,999, respectively. Seven states had more than 1,000 complaints.

```{r}

#Location data is only available for closed complaints. Create a new object called "complaint_locations" and filter for closed complaints.
complaint_locations <- complaints %>%
  filter(complaint_status == "closed_complaint") %>%
#Group by state and count.
  group_by(site_state) %>%
  count() %>%
#Arrange in descending order.
  arrange(desc(n))

complaint_locations



#New questions: Should we weight by number of workers in those states? If so, what time frame would we use such data from, given how COVID has affected the economy?
```


### Motivating Question 4. Which states have the fewest complaints?
### Answer: Utah had the fewest complaints with 2. Eight locations (including the U.S. Virgin Islands and the District of Columbia) had 25 or fewer complaints.
```{r}

#Location data is only available for closed complaints. Create a new object called "complaint_locations" and filter for closed complaints.
complaint_locations <- complaints %>%
  filter(complaint_status == "closed_complaint") %>%
#Group by state and count.
  group_by(site_state) %>%
  count() %>%
#Arrange in ascending order.
  arrange(n)

complaint_locations

#New questions: How can D.C. only have 6 complaints?


```


### Question 5. What are the details/nature of complaints [text analysis]

```{r}

stop_words_edited <- stop_words %>%
  filter(!str_detect(word, "serious"))

#Make all text in the hazard description lowercase.
text_analysis <- complaints_industry_codes %>%
  filter(complaint_status == "closed_complaint") %>%
  ungroup() %>%
  select(upa_number, site_state, hazard_desc_location) %>%
  mutate(hazard_desc_location = tolower(hazard_desc_location)) 


complaints_closed_words <- text_analysis %>% 
  unnest_tokens(word, hazard_desc_location, token="words") %>%
  anti_join(stop_words_edited) %>%
  mutate(word = str_remove_all(word, "[0-9]")) %>%
  mutate(word = str_remove_all(word,"[:punct:]")) %>%
  group_by(word) %>% 
  count() %>%
  arrange(desc(n)) %>%
  anti_join(stop_words_edited) %>%
  mutate(word_category = lemmatize_words(word)) %>%
  ungroup() %>%
  group_by(word_category) %>%
  summarise(n = sum(n)) %>%
  arrange(desc(n))


trigrams_complaints_closed <- text_analysis %>% 
  unnest_tokens(trigram, hazard_desc_location, token="ngrams", n=3) %>%
  group_by(trigram) %>%
  count() %>%
  arrange(desc(n))

tetragrams_complaints_closed <- text_analysis %>% 
  unnest_tokens(tetragram, hazard_desc_location, token="ngrams", n=4) %>%
  group_by(tetragram) %>%
  count() %>%
  arrange(desc(n))


pentagrams_complaints_closed <- text_analysis %>% 
  unnest_tokens(pentagram, hazard_desc_location, token="ngrams", n=5) %>%
  group_by(pentagram) %>%
  count() %>%
  arrange(desc(n))




sentences_complaints_closed <- text_analysis %>% 
  unnest_tokens(sentence, hazard_desc_location, token="sentences") %>%
  mutate(sentence = str_remove_all(sentence, "[0-9]")) %>%
  mutate(sentence = str_remove_all(sentence,"[:punct:]")) %>%
  mutate(sentence = str_trim(sentence, side="both")) %>%
  group_by(sentence) %>%
  count() %>%
  arrange(desc(n))



#complaints_y <- complaints %>%
#  filter(str_detect(hazard_desc_location, "^Employee|^employee"))

#Create a new object called "complaint_descriptions_frequency."
complaint_descriptions_frequency <- closed_complaints %>%

#Count the frequency of each complaint description.
  count(hazard_desc_location, sort= TRUE) %>%

#Arrange in descending order.
  arrange(desc(n))









```


### Motivating Question 6. How often do these complaints trigger on-site inspections? [join with inspection data]
```{r}

# We would join inspection data with closed_complaints on "establishment name."
# We need Sean to show us how to get the latest inspection data


```