---
title: "R Notebook"
output: html_notebook
---
This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 
Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
```{r}
# Load the tidyverse
```
## About this notebook
This is our final project notebook by Aadit and Kara. We will write a proper intro later.
## Load packages
```{r}
```
```{r}
#install.packages("tidytext")
#install.packages("blscrapeR")
install.packages("textstem")
library(tidyverse)
library(lubridate)
library(readxl)
library(janitor)
library(blscrapeR)
library(tidytext)
library(textstem)
```
## Load Data
```{r}
open_complaints <- read_excel("data/open_complaints.xlsx") %>%
  remove_empty() %>%
  slice(-1) %>%
  row_to_names(1) %>%
  clean_names() %>%
  mutate(complaint_status = "open_complaint")
closed_complaints <- read_excel("data/closed_complaints.xlsx") %>%
  remove_empty() %>%
  slice(-1) %>%
  row_to_names(1) %>%
  clean_names() %>%
  mutate(complaint_status = "closed_complaint")
complaints <- closed_complaints %>%
  bind_rows(open_complaints) %>%
  mutate(upa_receipt_date = as.numeric(upa_receipt_date)) %>%
  mutate(upa_receipt_date = excel_numeric_to_date(upa_receipt_date))
complaints
  
``` 
## Examine data
```{r}
# glimpse the data
glimpse(closed_complaints)
glimpse(open_complaints)
# view it
closed_complaints
open_complaints
```
```{r}
#I don't remember what this is. Aadit, do you?
compare_df_cols(open_complaints, closed_complaints) %>%
  arrange(desc(open_complaints))
```
## Motivating questions
## There were 31,278 closed complaints and 11,140 open complaints as of Nov. 6, 2020, for a total of 42,418 complaints.
```{r}
# Question 1. How many COVID-19-related complaints have been filed to OSHA?
# Create a new object called "totals." Group by complaint status and count for each category.
totals <- complaints %>%
  group_by(complaint_status) %>%
  count() %>%
# Reshape the dataframe so that complaint statuses are in columns.
  pivot_wider(names_from = complaint_status, values_from = n) %>%
# Create a new column by adding the values from the "closed_complaint" and "open_complaint" columns.  
  mutate(total=closed_complaint+open_complaint)
  
totals
```
##Motivating Question 2. What types of industries are complaints coming from?
```{r}
#Pull in industry codes dataframe using blscrapeR package.
industry_codes <- naics
  
complaints_x <- complaints %>%
  separate(primary_site_naics, sep = "/", into = c("primary_site_naics_1","primary_site_naics_2"))%>%
  mutate(primary_site_naics_1 = str_trim(primary_site_naics_1, side = "both"))%>%
  mutate(primary_site_naics_2 = str_trim(primary_site_naics_2, side = "both"))%>%
  mutate(naics_check = case_when(
    primary_site_naics_1 == primary_site_naics_2 ~ "true", 
    TRUE ~ "false"
    # primary_site_naics_1 != primary_site_naics_2 ~ "false"
  )) %>%
  mutate(primary_site_naics_1_5digit = str_sub(primary_site_naics_1, start = 1L, end = 5L)) %>%
  left_join(industry_codes, by = c("primary_site_naics_1_5digit" = "industry_code")) %>%
  rename(industry_title_5digit = industry_title) %>%
  mutate(primary_site_naics_1_2digit = str_sub(primary_site_naics_1, start = 1L, end = 2L)) %>%
  left_join(industry_codes, by = c("primary_site_naics_1_2digit" = "industry_code")) %>%
  rename(industry_title_2digit = industry_title) %>%
  mutate(primary_site_naics_1_3digit = str_sub(primary_site_naics_1, start = 1L, end = 3L)) %>%
  left_join(industry_codes, by = c("primary_site_naics_1_3digit" = "industry_code")) %>%
  rename(industry_title_3digit = industry_title) 
  #group_by(industry_title_3digit) %>%
  #count()
  #filter(is.na(industry_title)) %>%
  #group_by(industry_title) %>%
  #count()
  #group_by(naics_check) %>%
  #count()
  
```
```{r}
complaints_closed <- complaints_x %>%
  filter(complaint_status == "closed_complaint") %>%
  ungroup() %>%
  select(upa_number, hazard_desc_location) %>%
  mutate(hazard_desc_location = tolower(hazard_desc_location)) 
```
```{r}
complaints_closed_words <- complaints_closed %>% 
  unnest_tokens(word, hazard_desc_location, token="words") %>%
  anti_join(stop_words) %>%
  mutate(word = str_remove_all(word, "[0-9]")) %>%
  mutate(word = str_remove_all(word,"[:punct:]")) %>%
  group_by(word) %>% 
  count() %>%
  arrange(desc(n)) %>%
  anti_join(stop_words) %>%
  mutate(word_category = lemmatize_words(word)) %>%
  ungroup() %>%
  group_by(word_category) %>%
  summarise(n = sum(n)) %>%
  arrange(desc(n))
  
#install.packages('textstem')
#library(textstem)
complaints_closed_words  
```  
```{r}
complaints_closed_trigrams <- complaints_closed %>% 
  unnest_tokens(trigram, hazard_desc_location, token="ngrams", n=3) %>%
  group_by(trigram) %>%
  count() %>%
  arrange(desc(n))
```
```{r}
complaints_closed_sentences <- complaints_closed %>% 
  unnest_tokens(sentence, hazard_desc_location, token="sentences") %>%
  mutate(sentence = str_remove_all(sentence, "[0-9]")) %>%
  mutate(sentence = str_remove_all(sentence,"[:punct:]")) %>%
  mutate(sentence = str_trim(sentence, side="both")) %>%
  group_by(sentence) %>%
  count() %>%
  arrange(desc(n))

  unnest_tokens(sentences, hazard_desc_location, token="sentences") 
complaints_closed_words %>%
  group_by(sentences) %>%
  count() %>%
  arrange(desc(n))
```
##Motivating Question 3. Which states have the most complaints?
##Oregon and California had the most complaints with 5,772 and 4,999, respectively. Seven states had more than 1,000 complaints.
```{r}
#Location data is only available for closed complaints. Create a new object called "complaint_locations" and filter for closed complaints.
complaint_locations <- complaints %>%
  filter(complaint_status == "closed_complaint") %>%
#Group by state and count.
  group_by(site_state) %>%
  count() %>%
#Arrange in descending order.
  arrange(desc(n))
complaint_locations
#group by state and count, arrange descending
#New questions: Should we weight by number of workers in those states? If so, what time frame would we use such data from, given how COVID has affected the economy?
```
##Motivating Question 4. Which states have the fewest complaints?
##Utah had the fewest complaints with 2. Eight locations (including the U.S. Virgin Islands and the District of Columbia) had 25 or fewer complaints.
```{r}
#Location data is only available for closed complaints. Create a new object called "complaint_locations" and filter for closed complaints.
complaint_locations <- complaints %>%
  filter(complaint_status == "closed_complaint") %>%
#Group by state and count.
  group_by(site_state) %>%
  count() %>%
#Arrange in ascending order.
  arrange(n)
complaint_locations
#New questions: How can D.C. only have 6 complaints?
```
##Motivating Question 5. What are the details/nature of complaints [text analysis]
```{r}
complaints_y <- complaints %>%
  filter(str_detect(hazard_desc_location, "^Employee|^employee"))
```
##Motivating Question 6. How often do these complaints trigger inspections? [join with inspection data]
```{r}
We would join on "establishment name"
We need Sean to show us how to get the latest inspection data
```